name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ==================== é»‘ç›’æµ‹è¯• ====================
  black-box-test:
    name: é»‘ç›’æµ‹è¯• (Black-Box Testing)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
      working-directory: ./course-evaluation-system/backend
      run: |
        cat > src/main/resources/application.properties << 'EOF'
        server.port=8088
        server.servlet.context-path=/api
        spring.datasource.url=jdbc:postgresql://localhost:5432/test_db
        spring.datasource.username=test_user
        spring.datasource.password=test_password
        spring.datasource.driver-class-name=org.postgresql.Driver
        spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
        spring.jpa.hibernate.ddl-auto=create-drop
        spring.jpa.show-sql=false
        spring.sql.init.mode=always
        spring.sql.init.schema-locations=classpath:schema.sql
        spring.sql.init.data-locations=classpath:data.sql
        spring.jpa.defer-datasource-initialization=true
        spring.flyway.enabled=false
        jwt.secret=dGVzdEtleUZvckNJQ0RQaXBlbGluZVRlc3RpbmdPbmx5
        jwt.expiration=86400000
        spring.mail.host=smtp.test.com
        spring.mail.port=465
        spring.mail.username=test@test.com
        spring.mail.password=testpassword
        deepseek.api.key=test-key
        deepseek.api.url=https://api.deepseek.com/v1
        deepseek.model=deepseek-chat
        deepseek.enabled=false
        logging.level.org.springframework.web=WARN
        logging.level.org.hibernate=WARN
        logging.level.com.must=INFO
        EOF
    
    - name: è¿è¡Œé»‘ç›’æµ‹è¯•
      working-directory: ./course-evaluation-system/backend
      run: |
        echo "ðŸ§ª è¿è¡Œé»‘ç›’æµ‹è¯• (Black-Box Testing)"
        mvn test -Dtest="**/blackbox/*" -DfailIfNoTests=false
      continue-on-error: true
    
    - name: ä¸Šä¼ é»‘ç›’æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: black-box-test-reports
        path: course-evaluation-system/backend/target/surefire-reports/
        retention-days: 7

  # ==================== ç™½ç›’æµ‹è¯• ====================
  white-box-test:
    name: ç™½ç›’æµ‹è¯• (White-Box Testing)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
      working-directory: ./course-evaluation-system/backend
      run: |
        cat > src/main/resources/application.properties << 'EOF'
        server.port=8088
        server.servlet.context-path=/api
        spring.datasource.url=jdbc:postgresql://localhost:5432/test_db
        spring.datasource.username=test_user
        spring.datasource.password=test_password
        spring.datasource.driver-class-name=org.postgresql.Driver
        spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
        spring.jpa.hibernate.ddl-auto=create-drop
        spring.jpa.show-sql=false
        spring.sql.init.mode=always
        spring.sql.init.schema-locations=classpath:schema.sql
        spring.sql.init.data-locations=classpath:data.sql
        spring.jpa.defer-datasource-initialization=true
        spring.flyway.enabled=false
        jwt.secret=dGVzdEtleUZvckNJQ0RQaXBlbGluZVRlc3RpbmdPbmx5
        jwt.expiration=86400000
        spring.mail.host=smtp.test.com
        spring.mail.port=465
        spring.mail.username=test@test.com
        spring.mail.password=testpassword
        deepseek.api.key=test-key
        deepseek.api.url=https://api.deepseek.com/v1
        deepseek.model=deepseek-chat
        deepseek.enabled=false
        logging.level.org.springframework.web=WARN
        logging.level.org.hibernate=WARN
        logging.level.com.must=INFO
        EOF
    
    - name: è¿è¡Œç™½ç›’æµ‹è¯•
      working-directory: ./course-evaluation-system/backend
      run: |
        echo "ðŸ”¬ è¿è¡Œç™½ç›’æµ‹è¯• (White-Box Testing)"
        mvn test -Dtest="**/whitebox/*" -DfailIfNoTests=false
      continue-on-error: true
    
    - name: ä¸Šä¼ ç™½ç›’æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: white-box-test-reports
        path: course-evaluation-system/backend/target/surefire-reports/
        retention-days: 7

  # ==================== é›†æˆæµ‹è¯• ====================
  integration-test:
    name: é›†æˆæµ‹è¯• (Integration Testing)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
      working-directory: ./course-evaluation-system/backend
      run: |
        cat > src/main/resources/application.properties << 'EOF'
        server.port=8088
        server.servlet.context-path=/api
        spring.datasource.url=jdbc:postgresql://localhost:5432/test_db
        spring.datasource.username=test_user
        spring.datasource.password=test_password
        spring.datasource.driver-class-name=org.postgresql.Driver
        spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
        spring.jpa.hibernate.ddl-auto=create-drop
        spring.jpa.show-sql=false
        spring.sql.init.mode=always
        spring.sql.init.schema-locations=classpath:schema.sql
        spring.sql.init.data-locations=classpath:data.sql
        spring.jpa.defer-datasource-initialization=true
        spring.flyway.enabled=false
        jwt.secret=dGVzdEtleUZvckNJQ0RQaXBlbGluZVRlc3RpbmdPbmx5
        jwt.expiration=86400000
        spring.mail.host=smtp.test.com
        spring.mail.port=465
        spring.mail.username=test@test.com
        spring.mail.password=testpassword
        deepseek.api.key=test-key
        deepseek.api.url=https://api.deepseek.com/v1
        deepseek.model=deepseek-chat
        deepseek.enabled=false
        logging.level.org.springframework.web=WARN
        logging.level.org.hibernate=WARN
        logging.level.com.must=INFO
        EOF
    
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      working-directory: ./course-evaluation-system/backend
      run: |
        echo "ðŸ”— è¿è¡Œé›†æˆæµ‹è¯• (Integration Testing)"
        mvn test -Dtest="IntegrationTestWithStubs,IntegrationTestWithDrivers" -DfailIfNoTests=false
      continue-on-error: true
    
    - name: ä¸Šä¼ é›†æˆæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-reports
        path: course-evaluation-system/backend/target/surefire-reports/
        retention-days: 7

  # ==================== å‰ç«¯æž„å»ºæµ‹è¯• ====================
  frontend-test:
    name: å‰ç«¯æž„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: course-evaluation-system/frontend/package-lock.json
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      working-directory: ./course-evaluation-system/frontend
      run: npm ci
    
    - name: æž„å»ºå‰ç«¯
      working-directory: ./course-evaluation-system/frontend
      run: npm run build

  # ==================== æµ‹è¯•æ±‡æ€» ====================
  test-summary:
    name: æµ‹è¯•æ±‡æ€»
    needs: [black-box-test, white-box-test, integration-test, frontend-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ç”Ÿæˆæµ‹è¯•æ±‡æ€»
      run: |
        echo "## ðŸ“Š è½¯ä»¶æµ‹è¯•æ±‡æ€»æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æµ‹è¯•ç±»åž‹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| é»‘ç›’æµ‹è¯• | ${{ needs.black-box-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ç™½ç›’æµ‹è¯• | ${{ needs.white-box-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| é›†æˆæµ‹è¯• | ${{ needs.integration-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å‰ç«¯æž„å»º | ${{ needs.frontend-test.result }} |" >> $GITHUB_STEP_SUMMARY

  # ==================== æž„å»ºåº”ç”¨ ====================
  build:
    name: æž„å»ºåº”ç”¨
    needs: [black-box-test, white-box-test, integration-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: æž„å»ºåŽç«¯åº”ç”¨
      working-directory: ./course-evaluation-system/backend
      run: mvn clean package -DskipTests -q
    
    - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: course-evaluation-system/frontend/package-lock.json
    
    - name: æž„å»ºå‰ç«¯åº”ç”¨
      working-directory: ./course-evaluation-system/frontend
      run: |
        npm ci
        npm run build
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          course-evaluation-system/backend/target/*.jar
          course-evaluation-system/frontend/dist/
        retention-days: 7

  # ==================== éƒ¨ç½² ====================
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.build.result == 'success'
    environment: production
    
    steps:
    - name: ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
    
    - name: éƒ¨ç½²ä¿¡æ¯
      run: |
        echo "## ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
        echo "æž„å»ºäº§ç‰©å·²å‡†å¤‡å¥½ï¼Œå¯ä»¥éƒ¨ç½²åˆ°ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- äº‘æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
        echo "- Docker å®¹å™¨" >> $GITHUB_STEP_SUMMARY
        echo "- Kubernetes" >> $GITHUB_STEP_SUMMARY
